<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Document</title>
  </head>
  <body>
    <div id="map"></div>
    <pre>b2c0a136d9b169386e4df7cb9b6c291f514f6ded</pre>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.15.0/d3.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-queue/3.0.7/d3-queue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.js"></script>
    <script>
      async function getAllTheFilesFromEverywhere() {
        let cds = await (
          await fetch(
            'https://api.github.com/repositories/15808774/contents/cds/2016?ref=gh-pages',
            {
              headers: {
                Authorization: 'token b2c0a136d9b169386e4df7cb9b6c291f514f6ded',
              },
            },
          )
        ).json()
        cds = cds.slice(0, 15)
        console.log(cds)

        // Every -- in one directory (2016)
        let downloadUrls = cds.map(async directory => {
          let data = await fetch(directory.url, {
            headers: {
              Authorization: 'token b2c0a136d9b169386e4df7cb9b6c291f514f6ded',
            },
          })
          let district = await data.json()
          let [geoFile] = district.filter(d => d.name.includes('.geojson'))
          return geoFile.download_url
        })
        console.log(await downloadUrls)
        return await downloadUrls
        // Test: Single
        // let district = await (
        //   await fetch(cds.url, {
        //     headers: {
        //       Authorization: 'token b2c0a136d9b169386e4df7cb9b6c291f514f6ded',
        //     },
        //   })
        // ).json()
        // let [geojson] = district.filter(d => d.name.includes('.geojson'))
        // console.log(geojson.download_url)
        // return [geojson.download_url]
      }

      let downloadUrls = getAllTheFilesFromEverywhere()

      const width = 1024
      const height = 576

      const projection = d3
        .geoAlbersUsa()
        .scale(1280)
        .translate([width / 2, height / 2])

      const path = d3.geoPath().projection(projection)
      console.log(path)

      let svg = d3
        .select('#map')
        .append('svg')
        .attr('width', width)
        .attr('height', height)
      console.log(svg)

      function drawFromGeoJsonFile(url) {
        d3.json(url)
          .then(data => data.geometry)
          .then((data, err) => ready(err, data))
      }

      downloadUrls.then(urls =>
        urls.forEach(url => {
          drawFromGeoJsonFile(url)
        }),
      )

      /*  d3.json(
             'https://raw.githubusercontent.com/unitedstates/districts/gh-pages/cds/2016/AK-0/shape.geojson',
           )
             .then(data => data.geometry)
             .then((data, err) => ready(err, data))
      */
      function ready(err, alaska) {
        if (err) throw err
        console.log('Ready')

        svg
          .append('clipPath')
          .attr('id', 'clip-land')
          .append('use')
          .attr('xlink:href', '#Alaska')

        svg
          .append('g')
          .attr('class', 'district')
          .attr('clip-path', "url('clip-land')")
          .selectAll('path')
          .data(alaska)
          .enter()
          .append('path')
          .attr('d', path)
          .append('title')
          .text(function(d) {
            return d.properties.code
          })

        svg
          .append('path')
          .attr('class', 'district-boundaries')
          .datum(alaska, function(a, b) {
            return a !== b && a.properties.code === b.properties.code
          })
          .attr('d', path)
      }

      d3.select(self.frameElement).style('height', height + 'px')
    </script>
  </body>
</html>
